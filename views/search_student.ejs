<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Student</title>

    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/leetcode_style.css">

    <!-- Chart JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="top-navbar">
        <header class="main-header">
            <h1>Teacher Dashboard üîç</h1>
            <p class="subtitle">Search Student Progress Using SAP ID</p>
        </header>
    </nav>

    <!-- SEARCH PANEL -->
    <div class="search-panel">
        <h2>Search Student</h2>
        <p>Enter the SAP ID to view the student's LeetCode performance.</p>

        <form action="/admin/search" method="POST" class="search-form">
            <input type="text" name="sapid" placeholder="Enter SAP ID..." required />
            <button type="submit">Search</button>
        </form>

        <% if(error) { %>
            <div class="error-box">
                ‚ùå <%= error %>
            </div>
        <% } %>
    </div>

    <!-- ‚úÖ STUDENT + DASHBOARD -->
    <% if(student) { %>

        <!-- STUDENT PROFILE -->
        <div class="student-profile-card">

            <div class="student-profile-box">
                <img id="leetcodeAvatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="avatar">

                <div class="student-profile-info">
                    <h3>Name: <span><%= student.name %></span></h3>
                    <p><b>SAP ID:</b> <span><%= student.SAP_ID %></span></p>
                    <p><b>LeetCode ID:</b> <span id="leetcodeUsername"><%= student.leetcode_id %></span></p>
                </div>
            </div>

            <div class="divider-line"></div>

            <!-- STATUS -->
            <p id="status">Loading LeetCode data...</p>

            <!-- DASHBOARD -->
            <div class="dashboard-wrapper">

                <!-- PROGRESS + BADGES -->
                <div class="leetcode_upper">

                    <!-- Progress Card -->
                    <div class="card progress-card">

                        <div class="chart-wrapper">
                            <div class="chart-container">
                                <canvas id="progressChart"></canvas>

                                <div class="chart-center-text">
                                    <div class="number" id="totalSolved">0</div>
                                    <div class="label">
                                        <svg class="check-icon" viewBox="0 0 16 16" fill="#58a6ff">
                                            <path
                                                d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z" />
                                        </svg>
                                        Solved
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label easy">Easy</div>
                                <div class="stat-value" id="easy">0</div>
                            </div>

                            <div class="stat-box">
                                <div class="stat-label medium">Medium</div>
                                <div class="stat-value" id="medium">0</div>
                            </div>

                            <div class="stat-box">
                                <div class="stat-label hard">Hard</div>
                                <div class="stat-value" id="hard">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Badge Card -->
                    <div class="card badge-card">
                        <div class="badge-header">
                            <div>
                                <div class="badge-title">Badges</div>
                                <div class="badge-count" id="badgeCount">0</div>
                            </div>
                            <div class="badge-arrow">‚Üí</div>
                        </div>

                        <div class="badge-icons" id="badgeSection"></div>

                        <div class="recent-badge-section">
                            <div class="recent-badge-label">Most Recent Badge</div>
                            <div id="recentBadge">No badges yet</div>
                        </div>
                    </div>

                </div>

                <!-- LEETCODE SUBMISSION HEATMAP -->
                <div class="leetcode_lower">
                    <div class="card heatmap-card">

                        <div class="heatmap-header">
                            <div class="heatmap-title" id="submissionText">
                                0 submissions in the past one year
                            </div>

                            <div class="heatmap-stats">
                                Total active days: <span id="activeDaysText">0</span>
                                <span style="margin: 0 8px;">|</span>
                                Max streak: <span id="streakText">0</span>
                            </div>
                        </div>

                        <div class="heatmap-scroll">
                            <div class="month-labels" id="monthLabels"></div>

                            <div class="heatmap-wrapper">
                                <div class="day-labels">
                                    <div>Mon</div>
                                    <div>Wed</div>
                                    <div>Fri</div>
                                </div>

                                <div class="heatmap" id="heatmap"></div>
                            </div>
                        </div>

                        <div class="legend">
                            <span>Less</span>
                            <div class="legend-item">
                                <div class="day"></div>
                                <div class="day level-1"></div>
                                <div class="day level-2"></div>
                                <div class="day level-3"></div>
                                <div class="day level-4"></div>
                            </div>
                            <span>More</span>
                        </div>

                    </div>
                </div>

                <!-- ‚úÖ CHALLENGE PROGRESS HEATMAP (Day 1-100) -->
                <div class="leetcode_lower" style="margin-top: 20px;">
                    <div class="card heatmap-card">

                        <div class="heatmap-header">
                            <div class="heatmap-title">
                                üöÄ 100 Days DSA Challenge Progress
                            </div>

                            <div class="heatmap-stats">
                                Completed: <span id="challengeCompletedDays">0</span> / 100 days
                                <span style="margin: 0 8px;">|</span>
                                Progress: <span id="challengeProgressPercent">0%</span>
                            </div>
                        </div>

                        <div class="challenge-heatmap-grid" id="challengeHeatmapGrid"></div>

                        <div class="legend" style="margin-top: 15px;">
                            <span>Not Started</span>
                            <div class="legend-item">
                                <div class="day" style="background-color: rgba(255,255,255,0.1);"></div>
                                <div class="day" style="background-color: #10b981;"></div>
                            </div>
                            <span>Completed</span>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <!-- LEETCODE SCRIPTS -->
        <script>
            const savedLeetcodeId = "<%= student.leetcode_id %>";
        </script>
        <script src="/leetcode.js"></script>

        <!-- ‚úÖ CHALLENGE PROGRESS SCRIPT -->
        <script>
            const studentSapId = "<%= student.SAP_ID %>";

            // Fetch Challenge Progress Data
            async function fetchChallengeProgress() {
                try {
                    const response = await fetch(`/admin/challenge-progress/${studentSapId}`);
                    const data = await response.json();

                    console.log("‚úÖ Challenge Progress Data:", data);
                    createChallengeHeatmap(data.challengeProgress);

                } catch (error) {
                    console.error("‚ùå Error fetching challenge progress:", error);
                }
            }

            // Create Challenge Heatmap (Day 1-100)
            function createChallengeHeatmap(progressArray) {
                console.log("Creating challenge heatmap with:", progressArray);

                // Get completed days as a Set for quick lookup
                const completedDays = new Set(progressArray.map(p => p.day));

                // Update stats
                const totalCompleted = completedDays.size;
                const progressPercent = Math.round((totalCompleted / 100) * 100);

                document.getElementById('challengeCompletedDays').textContent = totalCompleted;
                document.getElementById('challengeProgressPercent').textContent = progressPercent + '%';

                // Create 100 day cells
                const gridContainer = document.getElementById('challengeHeatmapGrid');
                gridContainer.innerHTML = '';

                for (let day = 1; day <= 100; day++) {
                    const cell = document.createElement('div');
                    cell.className = 'challenge-day-cell';
                    cell.textContent = day;
                    cell.title = `Day ${day}`;

                    // Mark as completed if day exists in progressArray
                    if (completedDays.has(day)) {
                        cell.classList.add('completed');

                        // Find the completion date
                        const dayData = progressArray.find(p => p.day === day);
                        if (dayData) {
                            const date = new Date(dayData.completedAt);
                            cell.title = `Day ${day} - Completed on ${date.toLocaleDateString()}`;
                        }
                    } else {
                        cell.title = `Day ${day} - Not completed`;
                    }

                    gridContainer.appendChild(cell);
                }

                console.log(`‚úÖ Created ${gridContainer.children.length} day cells`);
            }

            // Fetch data on page load
            fetchChallengeProgress();
        </script>

    <% } %>

</body>

</html>