<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search Student</title>

    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/leetcode_style.css">

    <!-- Chart JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>

<body>

    <!-- NAVBAR -->
    <nav class="top-navbar">
        <header class="main-header">
            <h1>Teacher Dashboard üîç</h1>
            <p class="subtitle">Search Student Progress Using SAP ID</p>
        </header>
        <div class="nav-right">
            <a href="/admin/admin-logout" class="nav-logout-btn">Logout</a>
        </div>
    </nav>

    <!-- SEARCH PANEL -->
    <div class="search-panel">
        <h2>Search Student</h2>
        <p>Enter the SAP ID or email address to view the student's performance.</p>

        <form action="/admin/search" method="POST" class="search-form">
            <input type="text" name="query" placeholder="Enter SAP ID or Email..." required />
            <button type="submit">Search</button>
        </form>

        <% if(error) { %>
            <div class="error-box">
                ‚ùå <%= error %>
            </div>
            <% } %>
    </div>

    <!-- STUDENT + DASHBOARD -->
    <% if(student) { %>

        <!-- STUDENT PROFILE -->
        <div class="student-profile-card">

            <div class="student-profile-box">

                <img id="leetcodeAvatar"
                    src="<%= student.avatar ? student.avatar : 'https://cdn-icons-png.flaticon.com/512/149/149071.png' %>"
                    alt="avatar"
                    onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png';">

                <div class="student-profile-info">

                    <h3>
                        Name:
                        <span>
                            <%= student.name ? student.name : "Unknown Student" %>
                        </span>
                    </h3>


                    <p>
                        <b>LeetCode Name:</b>
                        <span id="leetcodeDisplayName">Loading...</span>
                    </p>

                    <p>
                        <b>LeetCode ID:</b>
                        <span id="leetcodeUsername">
                            @<%= student.leetcode_id ? student.leetcode_id : "Not Provided" %>
                        </span>
                    </p>

                    <p>
                        <b>SAP ID:</b>
                        <span>
                            <%= student.SAP_ID ? student.SAP_ID : "Not Provided" %>
                        </span>
                    </p>
                    <p>
                        <b>Email:</b>
                        <span>
                            <%= student.email ? student.email : "Not Provided" %>
                        </span>
                    </p>
                </div>

            </div>



            <div class="divider-line"></div>

            <!-- STATUS -->
            <p id="status">Loading LeetCode data...</p>

            <!-- DASHBOARD -->
            <div class="dashboard-wrapper">

                <!-- PROGRESS + BADGES -->
                <div class="leetcode_upper">

                    <!-- Progress Card -->
                    <div class="card progress-card">

                        <div class="chart-wrapper">
                            <div class="chart-container">
                                <canvas id="progressChart"></canvas>

                                <div class="chart-center-text">
                                    <div class="number" id="totalSolved">0</div>
                                    <div class="label">
                                        <svg class="check-icon" viewBox="0 0 16 16" fill="#58a6ff">
                                            <path
                                                d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z" />
                                        </svg>
                                        Solved
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label easy">Easy</div>
                                <div class="stat-value" id="easy">0</div>
                            </div>

                            <div class="stat-box">
                                <div class="stat-label medium">Medium</div>
                                <div class="stat-value" id="medium">0</div>
                            </div>

                            <div class="stat-box">
                                <div class="stat-label hard">Hard</div>
                                <div class="stat-value" id="hard">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Badge Card -->
                    <div class="card badge-card">
                        <div class="badge-header">
                            <div>
                                <div class="badge-title">Badges</div>
                                <div class="badge-count" id="badgeCount">0</div>
                            </div>
                            <div class="badge-arrow">‚Üí</div>
                        </div>

                        <div class="badge-icons" id="badgeSection"></div>

                        <div class="recent-badge-section">
                            <div class="recent-badge-label">Most Recent Badge</div>
                            <div id="recentBadge">No badges yet</div>
                        </div>
                    </div>

                </div>

                <!-- Heatmap -->
                <div class="leetcode_lower">
                    <div class="card heatmap-card">

                        <div class="heatmap-header">
                            <div class="heatmap-title" id="submissionText">
                                0 submissions in the past one year
                            </div>

                            <div class="heatmap-stats">
                                Total active days: <span id="activeDaysText">0</span>
                                <span style="margin: 0 8px;">|</span>
                                Max streak: <span id="streakText">0</span>
                            </div>
                        </div>

                        <!-- NEW HEATMAP STRUCTURE -->
                        <div class="heatmap-scroll">
                            <div class="heatmap-content">

                                <div class="day-labels" id="dayLabels"></div>

                                <div class="months-container" id="monthsContainer"></div>

                            </div>
                        </div>

                        <div class="legend">
                            <span>Less</span>
                            <div class="legend-item">
                                <div class="day"></div>
                                <div class="day level-1"></div>
                                <div class="day level-2"></div>
                                <div class="day level-3"></div>
                                <div class="day level-4"></div>
                            </div>
                            <span>More</span>
                        </div>

                    </div>
                </div>

                <!-- 100 DAYS CHALLENGE PROGRESS -->
                <div class="leetcode_lower" style="margin-top: 20px;">
                    <div class="card heatmap-card challenge-card">

                        <div class="heatmap-header">
                            <div class="heatmap-title">
                                üöÄ 100 Days DSA Challenge Progress
                            </div>

                            <div class="heatmap-stats">
                                Completed: <span id="challengeCompletedDays">0</span> / 100 days
                                <span style="margin: 0 8px;">|</span>
                                Progress: <span id="challengeProgressPercent">0%</span>
                            </div>
                        </div>

                        <div class="challenge-heatmap-grid" id="challengeHeatmapGrid"></div>

                        <!-- Tooltip (fixed placement) -->
                        <div id="challengeTooltip" class="challenge-tooltip"></div>

                    </div>
                </div>

                <!-- 150 DAYS HEATMAP -->
                <div class="leetcode_lower" style="margin-top: 20px;">
                    <div class="card heatmap-card">

                        <div class="heatmap-header">
                            <div class="heatmap-title">
                                üìÖ 150 Days Challenge Heatmap (Feb 1 - 150 Days)
                            </div>

                            <div class="heatmap-stats">
                                Active Days: <span id="ch150ActiveDays">0</span>
                                <span style="margin: 0 8px;">|</span>
                                Max Streak: <span id="ch150MaxStreak">0</span>
                            </div>
                        </div>

                        <div class="ch150-scroll">
                            <div class="ch150-full">

                                <div class="ch150-months" id="ch150MonthLabels"></div>

                                <div class="ch150-wrapper">
                                    <div class="ch150-grid" id="ch150Heatmap"></div>
                                </div>

                            </div>
                        </div>

                        <div class="ch150-legend">
                            <span>Less</span>

                            <div class="ch150-legend-boxes">
                                <div class="ch150-cell"></div>
                                <div class="ch150-cell level-1"></div>
                                <div class="ch150-cell level-2"></div>
                                <div class="ch150-cell level-3"></div>
                                <div class="ch150-cell level-4"></div>
                            </div>

                            <span>More</span>
                        </div>

                    </div>
                </div>

            </div>
        </div>

        <!-- TOOLTIP -->
        <div id="ch150Tooltip" class="ch150-tooltip"></div>

        <!-- LEETCODE SCRIPT -->
        <script>
            const savedLeetcodeId = "<%= student.leetcode_id %>";
        </script>
        <!-- <script src="/leetcode.js"></script> -->

        <!-- 100 DAYS + 150 DAYS SCRIPT -->
        <script>
            const studentSapId = "<%= student.SAP_ID %>";

            // ================================
            // 100 DAYS HEATMAP FETCH
            // ================================
            async function fetchChallengeProgress() {
                try {
                    const response = await fetch(`/admin/challenge-progress/${studentSapId}`);
                    const data = await response.json();

                    console.log("‚úÖ Challenge Progress Data:", data);
                    createChallengeHeatmap(data.challengeProgress);

                } catch (error) {
                    console.error("‚ùå Error fetching challenge progress:", error);
                }
            }

            // ================================
            // 100 DAYS HEATMAP CREATE
            // ================================
            function createChallengeHeatmap(progressArray) {
                const tooltip = document.getElementById("challengeTooltip");
                const gridContainer = document.getElementById("challengeHeatmapGrid");

                const completedDays = new Set(progressArray.map(p => p.day));

                const totalCompleted = completedDays.size;
                const progressPercent = Math.round((totalCompleted / 100) * 100);

                document.getElementById("challengeCompletedDays").textContent = totalCompleted;
                document.getElementById("challengeProgressPercent").textContent = progressPercent + "%";

                gridContainer.innerHTML = "";

                for (let day = 1; day <= 100; day++) {
                    const cell = document.createElement("div");
                    cell.className = "challenge-day-cell";
                    cell.textContent = day;

                    let completedAtDate = null;

                    if (completedDays.has(day)) {
                        cell.classList.add("completed");

                        const dayData = progressArray.find(p => p.day === day);
                        if (dayData && dayData.completedAt) {
                            completedAtDate = new Date(dayData.completedAt);
                        }
                    }

                    // Tooltip hover FIXED
                    cell.addEventListener("mousemove", (e) => {
                        tooltip.style.display = "block";

                        if (completedAtDate) {
                            const formattedDate = completedAtDate.toLocaleString("en-IN", {
                                timeZone: "Asia/Kolkata",
                                dateStyle: "medium",
                                timeStyle: "short"
                            });

                            tooltip.innerHTML = `
                        <div style="color:#60a5fa;font-weight:800;">Day ${day}</div>
                        <div style="color:#e5e7eb;">Completed on: ${formattedDate}</div>
                    `;
                        } else {
                            tooltip.innerHTML = `
                        <div style="color:#9ca3af;font-weight:800;">Day ${day}</div>
                        <div style="color:#e5e7eb;">Not completed</div>
                    `;
                        }

                        const rect = gridContainer.getBoundingClientRect();

                        tooltip.style.left = (e.clientX - rect.left + 40) + "px";
                        tooltip.style.top = (e.clientY - rect.top - 30) + "px";
                    });

                    cell.addEventListener("mouseleave", () => {
                        tooltip.style.display = "none";
                    });

                    gridContainer.appendChild(cell);
                }
            }

            fetchChallengeProgress();

            // ================================
            // 150 DAYS HEATMAP FETCH
            // ================================
            async function fetchChallengeHeatmap150() {
                try {
                    const response = await fetch(`/admin/challenge-heatmap150/${studentSapId}`);
                    const data = await response.json();

                    console.log("‚úÖ 150 Days Heatmap Data:", data);
                    createHeatmap150(data.challengeProgress || []);

                } catch (error) {
                    console.error("‚ùå Error fetching 150 days heatmap:", error);
                }
            }

            // ================================
            // 150 DAYS HEATMAP CREATE
            // ================================
            function createHeatmap150(progressArray) {
                const heatmap = document.getElementById("ch150Heatmap");
                const tooltip = document.getElementById("ch150Tooltip");

                heatmap.innerHTML = "";

                const year = new Date().getFullYear();
                const startDate = new Date(year, 1, 1); // Feb 1

                const countMap = {};

                progressArray.forEach(item => {
                    if (!item.completedAt) return;

                    const dateObj = new Date(item.completedAt);

                    // ‚úÖ FIX: Use LOCAL date (not UTC)
                    const key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, "0")}-${String(dateObj.getDate()).padStart(2, "0")}`;

                    countMap[key] = (countMap[key] || 0) + 1;
                });

                let activeDays = 0;
                let streak = 0;
                let maxStreak = 0;

                for (let i = 0; i < 150; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(startDate.getDate() + i);

                    // ‚úÖ FIX: Local key generation for currentDate too
                    const key = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, "0")}-${String(currentDate.getDate()).padStart(2, "0")}`;

                    const count = countMap[key] || 0;

                    if (count > 0) {
                        activeDays++;
                        streak++;
                        maxStreak = Math.max(maxStreak, streak);
                    } else {
                        streak = 0;
                    }

                    const cell = document.createElement("div");
                    cell.classList.add("ch150-cell");

                    if (count === 1) cell.classList.add("level-1");
                    else if (count === 2) cell.classList.add("level-2");
                    else if (count === 3) cell.classList.add("level-3");
                    else if (count >= 4) cell.classList.add("level-4");

                    cell.addEventListener("mousemove", (e) => {
                        tooltip.style.display = "block";

                        const dayName = currentDate.toLocaleString("default", { weekday: "long" });
                        const formattedDate = currentDate.toDateString();

                        if (count > 0) {
                            tooltip.innerHTML = `
                    <div style="color:#ffd166;font-weight:800;">${count} Task(s) Completed</div>
                    <div>${dayName}, ${formattedDate}</div>
                `;
                        } else {
                            tooltip.innerHTML = `
                    <div style="color:#9ca3af;font-weight:800;">No Submission</div>
                    <div>${dayName}, ${formattedDate}</div>
                `;
                        }

                        tooltip.style.left = (e.pageX + 15) + "px";
                        tooltip.style.top = (e.pageY - 20) + "px";
                    });

                    cell.addEventListener("mouseleave", () => {
                        tooltip.style.display = "none";
                    });

                    heatmap.appendChild(cell);
                }

                document.getElementById("ch150ActiveDays").innerText = activeDays;
                document.getElementById("ch150MaxStreak").innerText = maxStreak;
            }

            fetchChallengeHeatmap150();
        </script>


        <% } %>
            <script>
                const CONFIG = {
                    startDate: "<%= challengeConfig.startDate %>",
                    unlockTime: "<%= challengeConfig.unlockTime %>"
                };
            </script>


            <script src="/app.js"></script>
            <script src="/leetcode.js"></script>
            <div class="heatmap-tooltip" id="heatmapTooltip"></div>

</body>

</html>